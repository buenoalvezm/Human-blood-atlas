---
title: "01_wellness_profiling"
output: html_document
autor: "María Bueno Álvez"
date: "2024-12-13"
editor_options: 
  chunk_output_type: console
---

# Set up

```{r}
source("scripts/functions/functions_analyses.R")
source("scripts/functions/functions_utility.R")
source("scripts/functions/functions_visualization.R")
source("scripts/functions/themes_palettes.R")

# Read in data
ht_data <- read_csv("data/wellness_data.csv")
manifest <- import_df("data/samples_2024-12-17.xlsx")
olink_targets <- read_csv("data/overlap_olink_platforms.csv")
secretome_hpa <- read_tsv("data/secretome_v24.tsv")

# Extract relevant information from Wellness metadata
wellness_meta <- 
  manifest |> 
  filter(Cohort == "WELL") |> 
  select(DAid, Age, Sex, `Extra data`) |> 
  mutate(
    visit = str_extract(`Extra data`, "(?<=visit: )\\d+"),                   
    subject = str_extract(`Extra data`, "(?<=subject_id: )\\d+-\\d+"),      
    month_of_sampling = str_extract(`Extra data`, "(?<=sample_date: )\\d{4}-\\d{2}-\\d{2}") |> 
      as.Date(format = "%Y-%m-%d") %>%                                    
      format("%m")                                                      
  ) |> 
  rename(sex = Sex, 
         age = Age) |> 
  select(-`Extra data`)

# Filter Wellness data to samples in the metadata
wellness_data <- 
  ht_data |> 
  filter(DAid %in% wellness_meta$DAid) |> 
  select(DAid, Assay, NPX, LOD, above_LOD)
```

# QC

## Duplicated samples

```{r}
# Duplicated samples
duplicated_entires <- 
  wellness_meta |> 
  group_by(subject) |> 
  count(visit) |> 
  filter(n > 1) 

# write_tsv(duplicated_entires, savepath("duplicated_samples.tsv"))
# 
# wellness_meta |> 
#   inner_join(duplicated_entires) |> 
#   write_tsv(savepath("duplicated_samples_meta.tsv"))

# Manual exclusion of duplicated samples
DAid_exclude <- c("DA11971", "DA12092", "DA12126")

wellness_data <-
  wellness_data |>
  filter(!DAid %in% DAid_exclude)

wellness_meta <-
  wellness_meta |>
  filter(!DAid %in% DAid_exclude)
```



## Number of visits per patient

```{r}
number_of_visits <- 
  wellness_meta |> 
  group_by(subject) |> 
  summarise(Number_of_visits = n_distinct(visit)) |> 
  arrange(Number_of_visits)  

#write_tsv(number_of_visits, savepath("number_of_visits.tsv"))

subjects_limited_visits <- 
  number_of_visits |> 
  filter(Number_of_visits < 3) |>
  pull(subject)

DAid_exclude_limited_visits <- 
  wellness_meta |> 
  filter(subject %in% subjects_limited_visits) |> 
  pull(DAid)

# Exclusion of subjects with < 3 visits
wellness_data <-
  wellness_data |>
  filter(!DAid %in% DAid_exclude_limited_visits)

wellness_meta <-
  wellness_meta |>
  filter(!DAid %in% DAid_exclude_limited_visits)
```

# LOD

Analyze the number of proteins consistently detected across all visits for each individual.
High consistency in detection rates across visits and individuals supports technical reliability and biological stability.

## Per sample

```{r}
lod_sample_dat <- 
  wellness_data |> 
  group_by(DAid) |> 
  count(above_LOD) 

lod_sample_dat_order <- 
  lod_sample_dat |> 
  filter(above_LOD == "Yes") |>
  arrange(-n)

lod_sample_dat|> 
  mutate(DAid = factor(DAid, levels = lod_sample_dat_order$DAid)) |>
  ggplot(aes(DAid, n, fill = above_LOD)) +
  geom_col() +
  theme_hpa(axis_x = F)

ggsave(savepath("LOD_per_sample.png"), h = 5, w = 15)

# Plot strange samples


```


## Per subject 

```{r}
dat <- 
  wellness_data |> 
  left_join(wellness_meta |> 
              select(DAid, subject, visit), by = "DAid") |> 
  group_by(subject, Assay) |> 
  summarize(above_LOD_count = sum(NPX > LOD), .groups = "drop") |> 
  ungroup() 

dat |> 
  group_by(subject) |> 
  count(above_LOD_count) |> 
  mutate(above_LOD_count = fct_rev(factor(above_LOD_count))) |> 
  ggplot(aes(subject, n, fill = above_LOD_count)) +
  geom_col() +
  scale_fill_viridis_d("Number of visits", direction = -1) +
  theme_hpa(angled = T) + #, axis_x = F
  xlab("Subject")

ggsave(savepath("LOD_per_sample_names.pdf"), h = 4, w = 18) #12


lod_subject_dat <- 
  dat |> 
  left_join(number_of_visits, by = "subject") |> 
  mutate(perc = above_LOD_count / Number_of_visits,
         class = case_when(perc == 0 ~ "None",
                           perc == 1 ~ "All",
                           perc > 0 & perc <= 0.5 ~ "Some: < 50%",
                           perc < 1 & perc > 0.5 ~ "Some: > 50%"))  |> 
  group_by(subject) |> 
  count(class) |> 
  mutate(class = factor(class, levels = rev(names(pal_detectability)))) 

average_all <- 
  lod_subject_dat |> 
  filter(class == "All") |> 
  pull(n) |> 
  mean() 

(average_all / length(unique(ht_data$Assay))) * 100

average_none <- 
  lod_subject_dat |> 
  filter(class == "None") |> 
  pull(n) |> 
  mean()

(average_none / length(unique(ht_data$Assay))) * 100


subject_order <- 
  lod_subject_dat |> 
  filter(class == "None") |> 
  arrange(-n)

lod_subject_dat |> 
  mutate(subject = factor(subject, levels = subject_order$subject)) |> 
  ggplot(aes(subject, n, fill = class)) +
  geom_col() +
  scale_fill_manual(values = pal_detectability) +
  theme_hpa() + #, axis_x = F
  xlab("Subject") +
  theme(axis.ticks.x = element_blank(), 
        axis.text.x = element_blank(),
        axis.line.x = element_blank())

ggsave(savepath("LOD_per_sample_names.pdf"), h = 6, w = 18) #12
```

## Overall

```{r}
proteins_above_50 <- 
  wellness_data |> 
  group_by(Assay) |> 
  count(above_LOD)  |> 
  arrange(-n) |> 
  filter(above_LOD == "Yes", 
         n > 578/2)

proteins_below_50 <- 
  wellness_data |> 
  group_by(Assay) |> 
  count(above_LOD)  |> arrange(-n) |> 
  filter(above_LOD == "No", 
         n > 578/2)

# Prepare data for Martin
proteins_above_50 |> 
  distinct(Assay) |> 
  left_join(ht_data |> 
              distinct(Assay, OlinkID, UniProt), by = "Assay") |> 
  write_csv("wellness_detected_proteins_above50perc.csv")
```

## Secretome analyses

```{r}
proteins_above_LOD_80 <- 
  wellness_data |> 
  group_by(Assay) |> 
  count(above_LOD)  |> 
  arrange(-n) |> 
  mutate(n = (n/578)*100) |> 
  filter(above_LOD == "Yes", 
         n >80)

proteins_below_LOD_80 <- 
  wellness_data |> 
  group_by(Assay) |> 
  count(above_LOD)  |> 
  arrange(-n) |> 
  mutate(n = (n/578)*100) |> 
  filter(above_LOD == "No", 
         n >80)

plot_donut(proteins_above_LOD_80$Assay) /
plot_donut(proteins_below_LOD_80$Assay) 

ggsave(savepath_results("Publication-figures", "Fig1d.pdf"), h = 6, w = 6)
```

# UMAP

Visualize stability of the proteome per sample.

```{r}
wellness_umap <- 
  do_umap(data = wellness_data, wide = F, impute = T, plots = F)

wellness_umap |> 
  left_join(wellness_meta |> 
              select(DAid, subject, visit), by =c("Sample" = "DAid")) |>
  ggplot(aes(UMAP1, UMAP2, color = subject, frame = visit)) +
  geom_point(show.legend = F) +
  geom_line(aes(group = subject), show.legend = F) +
  theme_hpa()

ggsave(savepath("wellness_umap.pdf"), h = 6, w = 6)
```

## Interactive visualization

```{r}
dynamic_plot_data <- 
  wellness_umap |> 
  rename(DAid = Sample) |> 
  left_join(wellness_meta, by = "DAid") 

# Create the ggplot object
p <- ggplot(dynamic_plot_data, aes(x = UMAP1, y = UMAP2, color = subject, frame = visit)) +
  geom_point(show.legend = F) +
  theme_hpa() +
  labs(x = "UMAP1", y = "UMAP2")

# Convert ggplot to a plotly object for interactivity
p_dynamic <- ggplotly(p)

# Display the dynamic plot
p_dynamic
```


# Mixed models

Identify proteins that are significantly differentially expressed between visits. Summarize as volcano plot & boxplots. 

Reinforce stability of the proteome by showing that very few proteins change over time. Highlight how few proteins vary across visits.

```{r}
# Prepare data for mixed effect modelling
data_mixed_model <- 
  wellness_data |> 
  select(DAid, Assay, NPX) %>%
  left_join(wellness_meta |> 
              mutate(visit = as.numeric(visit)) |> 
              select(DAid, subject, visit, age, sex), by = "DAid")

# Run mixed effect models on all proteins extracting the fixed effects
fixed_effects <- 
  map_df(unique(wellness_data$Assay), function(protein) {
    
    do_mixed_effect_model(df = data_mixed_model, 
                          type = "variance_explained",
                          protein = protein)
    
  })

# Run mixed effect models on all proteins extracting the variance explained
variance_explained <- 
  map_df(unique(wellness_data$Assay), function(protein) {
    
    do_mixed_effect_model(df = data_mixed_model, 
                          type = "variance_explained",
                          protein = protein)
    
  })
```

## Visualize 

### Overall

```{r}
order <- 
  fixed_effects |> 
  filter(Component == "Random Effects (Subject)") |> 
  arrange(-Proportion)

variance_explained |> 
  mutate(Assay = factor(Assay,
                        levels = order$Assay)) |> 
  filter(Component != "Residual") |> 
  ggplot(aes(Assay, Proportion, fill = Component)) +
  geom_col(position = "stack") +
  scale_fill_manual(values = c("#E8A29A", "#ABC8F6")) +
  theme_hpa(axis_x = F)
ggsave(savepath("MM-variance-explained.pdf"), h = 4, w = 18)
```

### Example age

```{r}
dat_age <- 
  mm_all_proteins |> 
  filter(term == "age") |> 
  arrange(p.value) |> 
  mutate(sig = case_when(p.value< 0.06 & estimate > 0 ~ "significant up",
                         p.value< 0.06 & estimate < 0 ~ "significant down",
                         TRUE ~ "not significant"))
labels_age <- 
  dat_age |> 
  top_n(n = 10, wt = -log10(p.value)) 

volcano_plot_age <- 
  dat_age |> 
  ggplot(aes(x = estimate, y = -log10(p.value), color = sig, label = Protein)) +
  geom_point(size = 1, alpha = 0.4, show.legend = F) + 
  geom_text_repel(data = labels_age, size = 2, show.legend = F) +
  geom_hline(yintercept = -log10(0.05), linetype = 'dashed', color = "darkgrey") +
  #geom_vline(xintercept = -1, linetype = 'dashed', color = "darkgrey") +
 # geom_vline(xintercept = 1, linetype = 'dashed', color = "darkgrey") +
  scale_color_manual(values = pal_de) +
  theme_hpa() +   
  theme(axis.text = element_text(size = 8),
        legend.position = "top") 
```

### Sex

```{r}
dat_sex <- 
  mm_all_proteins |> 
  filter(term == "sexM") |> 
  arrange(p.value) |> 
  mutate(sig = case_when(p.value< 0.06 & estimate > 0 ~ "significant up",
                         p.value< 0.06 & estimate < 0 ~ "significant down",
                         TRUE ~ "not significant"))
labels_sex <- 
  dat_sex |> 
  top_n(n = 10, wt = -log10(p.value)) 

volcano_plot_sex <- 
  dat_sex |> 
  ggplot(aes(x = estimate, y = -log10(p.value), color = sig, label = Protein)) +
  geom_point(size = 1, alpha = 0.4, show.legend = F) + 
  geom_text_repel(data = labels_sex, size = 2, show.legend = F) +
  geom_hline(yintercept = -log10(0.05), linetype = 'dashed', color = "darkgrey") +
  #geom_vline(xintercept = -1, linetype = 'dashed', color = "darkgrey") +
 # geom_vline(xintercept = 1, linetype = 'dashed', color = "darkgrey") +
  scale_color_manual(values = pal_de) +
  theme_hpa() +   
  theme(axis.text = element_text(size = 8),
        legend.position = "top") 

volcano_plot_sex + volcano_plot_age
ggsave(savepath("volcanos_wellness_MM.pdf"), h = 4, w = 10)

volcano_plot_age
ggsave(savepath("volcano_age_MM_wellness.pdf"), h = 4, w = 5)
```

### Proteins age

```{r}
top_age_proteins <- 
  dat_age |> 
  group_by(sig) |>
  top_n(n = 4, wt = -log10(p.value)) |> 
  filter(sig != "not significant") 

wellness_data |> 
  filter(Assay %in% top_age_proteins$Protein) |>
  left_join(wellness_meta |> 
              select(DAid, subject, age, visit)) |> 
  mutate(Assay = factor(Assay, levels = top_age_proteins$Protein)) |>
  ggplot(aes(age, NPX, color = age)) +
  geom_line(aes(group = subject), alpha = 0.3, color = "grey80") +
  geom_point() +
  geom_smooth(method = "lm", se = F, color = "white") +
  #geom_quasirandom(alpha = 0.7, show.legend = F) +
 # geom_boxplot(fill = NA, outlier.colour = NA, color = "grey20") +
 # scale_color_manual(values = pal_bamse) +
  scale_color_viridis_c(option = "magma") +
  facet_wrap(~Assay, scales = "free_y", nrow = 1) +
  theme_hpa() 
  
ggsave(savepath("top_age_proteins_bamse.pdf"), h = 2.5, w = 12)

wellness_data |> 
  filter(Assay %in% top_age_proteins$Protein) |>
  left_join(wellness_meta |> 
              select(DAid, subject, age, visit)) |> 
  mutate(Assay = factor(Assay, levels = top_age_proteins$Protein)) |>
  ggplot(aes(visit, NPX, color = visit)) +
  geom_line(aes(group = subject), alpha = 0.3, color = "grey80") +
  geom_point() +
  #geom_smooth(method = "lm", se = F, color = "white") +
  geom_quasirandom(alpha = 0.7, show.legend = F) +
  geom_boxplot(fill = NA, outlier.colour = NA, color = "grey20") +
 # scale_color_manual(values = pal_bamse) +
  scale_color_viridis_d(option = "magma") +
  facet_wrap(~Assay, scales = "free_y", nrow = 2) +
  theme_hpa(axis_x = F) 
  
ggsave(savepath("top_age_proteins_wellness_d.pdf"), h = 2.5, w = 12)
ggsave(savepath("top_age_proteins_wellness_d.pdf"), h = 3.5, w = 8)


top_sex_proteins <- 
  dat_sex |> 
  group_by(sig) |>
  top_n(n = 4, wt = -log10(p.value)) |> 
  filter(sig != "not significant") 

bamse_data |> 
  filter(Assay %in% top_sex_proteins$Protein) |>
  left_join(bamse_meta |> 
              select(DAid, subject, Sex)) |> 
  mutate(Assay = factor(Assay, levels = top_sex_proteins$Protein)) |>
  ggplot(aes(Sex, NPX, color = Sex)) +
  geom_line(aes(group = subject), alpha = 0.3, color = "grey80") +
  geom_quasirandom(alpha = 0.7, show.legend = F) +
  geom_boxplot(fill = NA, outlier.colour = NA, color = "grey20") +
  #scale_color_manual(values = pal_bamse) +
  facet_wrap(~Assay, scales = "free_y", nrow = 1) +
  theme_hpa(axis_x = F) 

ggsave(savepath("top_sex_proteins_wellness.pdf"), h = 2.5, w = 12)
```